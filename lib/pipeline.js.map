{"version":3,"sources":["pipeline.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;;;;;;;2BAKR,eAAe;;2BACD,eAAe;;;;oBACjB,MAAM;;;;0BAIlB,cAAc;;;;;;IAKb,cAAc;;;;;AAIP,WAJP,cAAc,GAIJ;0BAJV,cAAc;;AAKhB,QAAI,CAAC,UAAU,GAAG,4BAAe,CAAC;AAClC,QAAI,CAAC,OAAO,GAAG,yBAAO,KAAK,CAAC;AAC1B,SAAG,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI;KAC3B,CAAC,CAAC;GACJ;;;;;;;;;;eATG,cAAc;;WAkBb,eAAC,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,eAAe,EAAE;;;AAClD,aAAO,OAAO,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,YAAM;AAClC,YAAI,GAAG,CAAC;AACR,YAAI,OAAO,CAAC,KAAK,EAAE;AACjB,aAAG,GAAG,OAAO,CAAC,KAAK,CAAC,aAAa,CAAC;SACnC;AACD,WAAG,GAAG,GAAG,IAAI,kBAAK,EAAE,EAAE,CAAC;AACvB,YAAI,QAAQ,CAAC;AACb,YAAI,OAAO,CAAC,MAAM,EAAE;AAClB,kBAAQ,GAAG,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC;SAC/B;AACD,cAAK,OAAO,CAAC,IAAI,CAAC,uBAAuB,EAAE,QAAQ,CAAC,CAAC;AACrD,YAAI,eAAe,IAAI,eAAe,CAAC,MAAM,EAAE;AAC7C,gBAAK,OAAO,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC;AAC1C,cAAI,eAAe,CAAC,MAAM,CAAC,GAAG,EAAE;AAC9B,oBAAQ,GAAG,eAAe,CAAC,MAAM,CAAC,GAAG,CAAC;WACvC,MAAM;AACL,oBAAQ,GAAG,eAAe,CAAC,MAAM,CAAC;WACnC;SAEF;AACD,cAAK,OAAO,CAAC,IAAI,CAAC,yBAAyB,EAAE,QAAQ,CAAC,CAAC;AACvD,YAAI,EAAE,GAAG,sBAAU;AACjB,uBAAa,EAAE,OAAO,CAAC,WAAW,CAAC,GAAG;AACtC,iBAAO,EAAE,kBAAK,EAAE,EAAE;AAClB,mBAAS,EAAE,SAAS;AACpB,qBAAW,EAAE,OAAO,CAAC,WAAW;AAChC,kBAAQ,EAAE,QAAQ;AAClB,uBAAa,EAAE,GAAG;AAClB,iBAAO,EAAE,OAAO;SACjB,CAAC,CAAC;;AAEH,eAAO,MAAK,UAAU,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY;AAClD,iBAAO,EAAE,CAAC,QAAQ,EAAE,CAAC;SACtB,CAAC,CAAC;OACJ,CAAC,CAAC;KACJ;;;SAtDG,cAAc;;;qBAyDL,cAAc","file":"pipeline.js","sourcesContent":["'use strict';\n\nimport {\n  Publisher\n}\nfrom '@hoist/broker';\nimport logger from '@hoist/logger';\nimport uuid from 'uuid';\nimport {\n  Event\n}\nfrom '@hoist/model';\n\n/**\n * Hoist Pipeline class for raising events\n */\nclass EventsPipeline {\n  /**\n   * create a new pipeline object\n   */\n  constructor() {\n    this._publisher = new Publisher();\n    this._logger = logger.child({\n      cls: this.constructor.name\n    });\n  }\n\n  /**\n   * raise an event with the given name and payload\n   * @param {Context} context - the current context\n   * @param {String} eventName - the name of the event to raise\n   * @param {Object} payload - any mata data to save\n   * @returns {Promise<Object>} - the Bucket in object form\n   */\n  raise(context, eventName, payload, overrideContext) {\n    return Promise.resolve().then(() => {\n      var cid;\n      if (context.event) {\n        cid = context.event.correlationId;\n      }\n      cid = cid || uuid.v4();\n      var bucketId;\n      if (context.bucket) {\n        bucketId = context.bucket._id;\n      }\n      this._logger.info('bucketId from context', bucketId);\n      if (overrideContext && overrideContext.bucket) {\n        this._logger.info('overrideing bucketid');\n        if (overrideContext.bucket._id) {\n          bucketId = overrideContext.bucket._id;\n        } else {\n          bucketId = overrideContext.bucket;\n        }\n\n      }\n      this._logger.info('bucketid after override', bucketId);\n      var ev = new Event({\n        applicationId: context.application._id,\n        eventId: uuid.v4(),\n        eventName: eventName,\n        environment: context.environment,\n        bucketId: bucketId,\n        correlationId: cid,\n        payload: payload\n      });\n\n      return this._publisher.publish(ev).then(function () {\n        return ev.toObject();\n      });\n    });\n  }\n}\n\nexport default EventsPipeline;\n\n/**\n * @external {Context} https://github.com/hoist/hoist-context/blob/feature/remove_cls/src/index.js\n */\n"],"sourceRoot":"/source/"}